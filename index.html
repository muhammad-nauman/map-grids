<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title></title>
    <meta name="author" content="">
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/spin.js/4.1.0/spin.min.css" integrity="sha512-ssYEuK9Epo/48VIlBWTFosf1izrgGZqEMELJP+L7Clh0nvaOSTg87dM+Z8L+KKjrPdMbMvKYOOnzBOkNMhWFsg==" crossorigin="anonymous" />
    <style type="text/css">
    #map {
        position: relative;
        top: 0px;
        left: 0px;
        width: 100%;
        height: 100vh;
        border: 1px solid #999;
        z-index: 100;
    }
    .loader {
    	position: absolute;
		border: 16px solid #f3f3f3; /* Light grey */
		border-top: 16px solid #3498db; /* Blue */
		border-radius: 50%;
		width: 120px;
		height: 120px;
		animation: spin 2s linear infinite;
		top: 0;
		bottom: 0;
		left: 0;
		right: 0;
	}

	@keyframes spin {
	  0% { transform: rotate(0deg); }
	  100% { transform: rotate(360deg); }
	}
    </style>
</head>

<body>
    <div id="map"></div>
    <div class="loader"></div>
    <script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?v=3.10&sensor=false&libraries=geometry,places"></script>
    <script src="https://unpkg.com/@googlemaps/markerclustererplus/dist/index.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.5.1.min.js" integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
	<script type="text/javascript" src="https://cdn.jsdelivr.net/gh/geocodezip/v3-utility-library@master/archive/maplabel/src/maplabel.js"></script>
    <script>
    var map,
        myCenter = new google.maps.LatLng(29.36847417787891, 70.04310603094801),
        gridstyle = { strokeColor: 'yellow', strokeWeight: 1 };
    grid = [],
        markers = [],
        doctors = []
    // doctors = doctors.sort(() => 0.5 - Math.random()).slice(0, 200)
    doctors = doctors
        .filter(doctor => doctor.Latitude !== null && doctor.Longitude !== null)
        .filter((thing, index, self) =>
            index === self.findIndex((t) => (
                t.Latitude === thing.Latitude && t.Longitude === thing.Longitude
            )))

    function fetchDoctors() {
    	return fetch('https://portal.hudsonpharma.com/HudsonService.svc/GetKarachiDoctorsWithLongLat')
    		.then(response => response.json())
    		.then(response => {
    			doctors = JSON.parse(response.d)
    			doctors = doctors
			        .filter(doctor => doctor.Latitude !== null && doctor.Longitude !== null)
			        .filter((thing, index, self) =>
			            index === self.findIndex((t) => (
			                t.Latitude === thing.Latitude && t.Longitude === thing.Longitude
			            )))

		        return doctors;
    		})
    }

    function initialize() {
        var mapProp = {
            center: myCenter,
            zoom: 10,
            mapTypeId: google.maps.MapTypeId.ROADMAP,
            scaleControl: true
        };

        map = new google.maps.Map(document.getElementById('map'), mapProp);
        var gridsize = 0.008 * 7; //Grid size in degrees
        this.doctors.map(function(doctor) {
            const addedMarkers = markers.filter(marker => {
                marker.label === `${doctor.DoctorName}-${doctor.DoctorCode}`
            })
            if (addedMarkers.length === 0) {
                var markerposition = { lat: doctor.Latitude, lng: doctor.Longitude };
                var marker = new google.maps.Marker({
                    position: new google.maps.LatLng(markerposition.lat, markerposition.lng),
                    label: `${doctor.DoctorName}-${doctor.DoctorCode}`
                });
                markers.push(marker);
            }
        })
        google.maps.event.addListener(map, 'bounds_changed', function() {
            var gridline,
                gridlat,
                gridlon,
                n = map.getBounds().getNorthEast().lat(),
                s = map.getBounds().getSouthWest().lat();
            e = map.getBounds().getNorthEast().lng(),
                w = map.getBounds().getSouthWest().lng()
            // If a previous grid and markers are set, we remove them.
            if (grid.length > 0) {
                /*  for (var i = 0; i < grid.length; i++) { grid[i].setMap(null);	 } */
            }

            var sgrid = Math.round(s / gridsize) * gridsize;
            var wgrid = Math.round(w / gridsize) * gridsize;

            for (gridlat = sgrid; gridlat < n; gridlat = gridlat + gridsize) {
                var gridline = new google.maps.Polygon({
                    path: [{ lat: gridlat, lng: e }, { lat: gridlat, lng: w }],
                    map: map
                });
                gridline.setOptions(gridstyle);
                grid.push(gridline);
            }
            for (gridlng = wgrid; gridlng < e; gridlng = gridlng + gridsize) {
                var gridline = new google.maps.Polygon({
                    path: [{ lat: n, lng: gridlng }, { lat: s, lng: gridlng }],
                    map: map
                });
                gridline.setOptions(gridstyle);
                grid.push(gridline);
            }
            var labels = [];
            [
            	{lat: 24.8352349, long: 66.9970123},
            	{lat: 24.792920, long: 67.065553},
            	{lat: 24.8307456, long: 67.0551665},
            	{lat: 24.836465, long: 67.122192},
            	{lat: 24.831898, long: 67.165636},
            ].map((coord, index) => {
            	labels.push(new MapLabel({
			        text: 'PK-KHI-' + (index + 1),
			        position: new google.maps.LatLng(coord.lat, coord.long),
			        map: map,
			        fontSize: 16,
			        align: 'center'
			    }));
            })
            // Here we create the markers.
      //       var mapLabel = new MapLabel({
		    //     text: 'PK-KCHI-1',
		    //     position: new google.maps.LatLng(24.8352349, 66.9970123),
		    //     map: map,
		    //     fontSize: 16,
		    //     align: 'center'
		    // });
		    // // Here we create the markers.
      //       var mapLabel = new MapLabel({
		    //     text: 'PK-KCHI-2',
		    //     position: new google.maps.LatLng(24.792920, 67.065553),
		    //     map: map,
		    //     fontSize: 16,
		    //     align: 'center'
		    // });
		    // // Here we create the markers.
      //       var mapLabel = new MapLabel({
		    //     text: 'PK-KCHI-3',
		    //     position: new google.maps.LatLng(24.792920, 67.065553),
		    //     map: map,
		    //     fontSize: 16,
		    //     align: 'center'
		    // });
		    // // Here we create the markers.
      //       var mapLabel = new MapLabel({
		    //     text: 'PK-KCHI-4',
		    //     position: new google.maps.LatLng(24.792920, 67.065553),
		    //     map: map,
		    //     fontSize: 16,
		    //     align: 'center'
		    // });
		    // // Here we create the markers.
      //       var mapLabel = new MapLabel({
		    //     text: 'PK-KCHI-5',
		    //     position: new google.maps.LatLng(24.792920, 67.065553),
		    //     map: map,
		    //     fontSize: 16,
		    //     align: 'center'
		    // });

            var markerCluster = new MarkerClusterer(map, markers, {
                imagePath: "https://developers.google.com/maps/documentation/javascript/examples/markerclusterer/m",
            });
        });
    }
    $().ready(function() {
    	$('#map').hide();
    	fetchDoctors().then(response => {

    		$('#map').show();
    		$('.loader').hide();
    		initialize()
    	});
    });
    </script>
</body>

</html>